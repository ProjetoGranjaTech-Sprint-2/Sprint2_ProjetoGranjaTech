<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard/Sensores</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <link rel="stylesheet" href="../css/viewDashboards.css">
</head>
<body>

  <div class="card">
    <div class="mensagem" id="mensagem"></div>
  </div>

    <header>
        <div class="logo"></div>
        <nav>
            <ul>
                <li><a href="./dashbords.html">Galpão</a></li>
                <li>Dashboards</li>
                <li>Avisos</li>
                <li>Ajuda</li>
            </ul>
        </nav>
        <div class="sair">
            <i class="material-symbols-outlined">logout</i>
            <p>Sair</p>
        </div>
    </header>

    <main>
        <section class="graficos">
            <div class="grafico">
                <canvas id="graficoTemp"></canvas>
            </div>
            <div class="grafico">
                <canvas id="graficoUmi"></canvas>
            </div>
        </section>
        <section class="graficos">
            <div class="status">
                <h2>ESTÁVEL</h2>
                <div class="sensores">
                    <i class="material-symbols-outlined">chevron_left</i>
                    <div class="kpi_sensores">
                        <div class="container_dados">
                            <span id="temp">23°C</span>
                            <span id="umi">25%</span>
                        </div>
                        <!-- <p id="sensor"></p> -->
                        <select name="" id="selectCustom">
                          <option value="">SENSOR 1</option>
                          <option value="">SENSOR 2</option>
                          <option value="">SENSOR 4</option>
                          <option value="">SENSOR 5</option>
                          <option value="">SENSOR 6</option>
                          <option value="">SENSOR 7</option>
                        </select>
                    </div>
                    <i class="material-symbols-outlined">chevron_right</i>
                </div>
            </div>
            <div id="sinalização">
                <span>cor1</span>
                <span>cor2</span>
                <span>cor3</span>
                <span>cor4</span>
                <span>cor5</span>
            </div>
            <div id="tabela">TABELA</div>
        </section>    
    </main>

</body>
</html>

<script>


let proximaAtualizacao;

window.onload = obterDados();

function sumirMensagem() {
  let card = document.querySelector('.card')
  card.style.display = 'none'
}

function alertRecepcao() {
  var nomeUsuario = document.getElementById(`mensagem`)
  nomeUsuario.innerHTML = 'Olá ' + sessionStorage.NOME_USUARIO + ', sejá bem-vindo!'

  setTimeout(sumirMensagem, 2000);
}


function obterDados() {

alertRecepcao();

if (proximaAtualizacao != undefined) {
    clearTimeout(proximaAtualizacao);
}

fetch(`/acesso/buscarTop10`, {
    method: "POST",
    headers: {
    "Content-Type": "application/json",
    },
    body: JSON.stringify({
    idUser: sessionStorage.ID_USUARIO
    }),
})
.then(function (resposta) {
    console.log("resposta: ", resposta);

    if (resposta.ok) {
        resposta.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta);

        limparFormulario();
        finalizarAguardar();
    });
    } else {
        throw "Nenhum dado encontrado ou erro na API";
    }
})
.catch(function (error) {
    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
});

}


function plotarGrafico(resposta) {

console.log('iniciando plotagem do grafico...')
    
var nome_musica = []

var data = []


for (i = 0; i < resposta.length; i++) {
        var registro = resposta[i];
        nome_musica.push(registro.NomeMúsica);
        data.push(registro.Repetições);
    }


let myChart = new Chart(
    document.getElementById(`grafico`), {
    type: 'bar',
    data: {
        labels: nome_musica,
        datasets: [{
            label: 'Músicas mais acessadas',
            data: data,
            borderWidth: 1
        }]
    },
});

setTimeout(() => atualizarGrafico(data, nome_musica, myChart))
}

function atualizarGrafico(data, nome_musica, myChart) {


fetch(`/acesso/buscarTop10`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (novoRegistro) {

                obterdados();
                console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                console.log(`Dados atuais do gráfico:`);
                console.log(data, nome_musica);



                if (novoRegistro[0].NomeMúsica == nome_musica[nome_musica.length - 1]) {
                    console.log("---------------------------------------------------------------")
                    console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                    console.log("Horário do novo dado capturado:")
                    console.log(novoRegistro[0].NomeMúsica)
                    console.log("Horário do último dado capturado:")
                    console.log(nome_musica[nome_musica.length - 1])
                    console.log("---------------------------------------------------------------")
                } else {
                    // tirando e colocando valores no gráfico
                    nome_musica.shift(); // apagar o primeiro
                    nome_musica.push(novoRegistro[0].NomeMúsica); // incluir um novo momento

                    data.shift();  // apagar o primeiro de umidade
                    data.push(novoRegistro[0].Repetições); // incluir uma nova medida de umidade

                    myChart.update();
                }

                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(data, nome_musica, myChart), 2000);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(data, nome_musica, myChart), 2000);
        }
    })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });


}



const ChartTemp = document.getElementById('graficoTemp');

new Chart(ChartTemp, {
  type: 'line',
  data: {
    labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
    datasets: [{
      label: 'Temperatura °C',
      data: [12, 19, 3, 5, 2, 3],
      backgroundColor: '#fd582f',
      borderColor: '#fd582f'
    }]
  },
  options: {
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});

const ChartUmi = document.getElementById('graficoUmi');

new Chart(ChartUmi, {
  type: 'line',
  data: {
    labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
    datasets: [{
      label: 'Umidade %',
      data: [12, 19, 3, 5, 2, 3],
      backgroundColor: '#6633ff',
      borderColor: '#6633ff',
    }]
  },
  options: {
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});



</script>