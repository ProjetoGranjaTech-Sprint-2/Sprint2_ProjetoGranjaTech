<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard/Sensores</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <link rel="stylesheet" href="../css/viewDashboards.css">
</head>

<body>

  <div class="card">
    <div class="mensagem" id="mensagem"></div>
  </div>

  <header>
    <div class="logo"></div>
    <nav>
      <ul>
        <li><a href="./dashbords.html">Galpão</a></li>
        <li><a href="./viewDashboards.html">Dashboards</a></li>
        <li>Avisos</li>
        <li><a href="./ajuda.html">Ajuda</a></li>
      </ul>
    </nav>
    <div class="sair">
      <i class="material-symbols-outlined">logout</i>
      <p>Sair</p>
    </div>
  </header>

  <main>
    <section class="graficos">
      <div id="grafico">
        <!-- <canvas id="myChartTemp"></canvas> -->
      </div>
      <div id="grafico2">
        <!-- <canvas id="graficoUmid"></canvas> -->
      </div>
    </section>
    <section class="graficos">
      <div class="status">
        <h2>ESTÁVEL</h2>''
        <div class="sensores">
          <i class="material-symbols-outlined">chevron_left</i>
          <div class="kpi_sensores">
            <div class="container_dados">
              <span id="temp"></span>
              <span id="umi"></span>
            </div>
            <!-- <p id="sensor"></p> -->
            <select name="sensores" id="selectCustom">
              <!-- <option value="">SENSOR 1</option>
              <option value="">SENSOR 2</option>
              <option value="">SENSOR 4</option>
              <option value="">SENSOR 5</option>
              <option value="">SENSOR 6</option>
              <option value="">SENSOR 7</option> -->
            </select>
          </div>
          <i class="material-symbols-outlined">chevron_right</i>
        </div>
      </div>
      <div id="sinalização">
        <span>cor1</span>
        <span>cor2</span>
        <span>cor3</span>
        <span>cor4</span>
        <span>cor5</span>
      </div>
      <div id="tabela">TABELA</div>
    </section>
    <div>
      <button onclick="gerarPDF()">Download Relatório</button>
    </div>
  </main>

</body>

</html>

<script>
  // const ctx = document.getElementById('myChartTemp');

  let proximaAtualizacao;
  let idSensor; // Pegar o ID da rota de listar sensores
  // let myChartTemp = null;
  // var contador = 0;



  window.onload = listarSensor(), chamarGrafico();
  window.jsPDF = window.jspdf.jsPDF;


  function chamarGrafico() {
    // var sensores = JSON.parse(sessionStorage.ID_SENSOR);
    document.getElementById("grafico").innerHTML = `
    <canvas id="myChartTemp${idSensor}"></canvas>
  `
    document.getElementById("grafico2").innerHTML = `
    <canvas id="myChartUmid${idSensor}"></canvas>
  `
  }

  function listarSensor(idGalinheiro) {
    var idGalinheiro = sessionStorage.ID_GALINHEIRO;
    idSensor; //

    fetch(`/sensores/listarSensor/${idGalinheiro}`, {
      method: "GET",
    }).then(function (resposta) {
      resposta.json().then((sensores) => {
        // if (resposta.length > 0){
        // }
        sensores.forEach((sensor) => {
          selectCustom.innerHTML += `<option value='${sensor.id}'> S${sensor.id} ${sensor.tipo}</option>`;
          idSensor = sensor.id; // PEGAR O ID DO SENSOR
          sessionStorage.ID_SENSOR = idSensor;
          dadosSensor(idSensor);
          chamarGrafico();
        });
      });
    })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function sumirMensagem() {
    let card = document.querySelector('.card')
    card.style.display = 'none'
  }

  function alertRecepcao() {
    var nomeUsuario = document.getElementById(`mensagem`)
    nomeUsuario.innerHTML = 'Olá ' + sessionStorage.NOME_USUARIO + ', sejá bem-vindo!'

    setTimeout(sumirMensagem, 2000);
  }

  var idHist, fkSensor, timeVrf, stats, uniMedida; // RECEBER VALORES DO HISTÓRICO COMO VARIÁVEIS

  function dadosSensor(idSensor) {
    // alertRecepcao();
    var idGalinheiro = sessionStorage.ID_GALINHEIRO;
    idSensor; // COLOCAR O ID NESSA ROTA
    console.log(idSensor);
    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/sensores/dadosSensor/${idSensor}`, { cache: 'no-store' }, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    }).then(function (resposta) {

      resposta.json().then(resposta => {
        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
        console.log(resposta);
        resposta.forEach((historico) => {
          idHist = resposta[0].idHist;
          fkSensor = resposta[0].fkSensor;
          timeVrf = resposta[0].timeVrf;
          stats = resposta[0].stats;
          uniMedida = resposta[0].uniMedida;

          var tamanhoLista = resposta.length;



          // if (registro.uniMedida == `%`){
          // umi.innerHTML += `<span>${resposta[0].stats}${resposta[0].uniMedida}</span>`
          // }

          // MUDAR VALORES NA TELA 
          // idEquipamento = resposta[0].idEquipamento;
          // if (idEquipamento == undefined) {
          //   setTimeout(function () {
          //     console.log("Redirecionando")
          //     window.location = "./statsBattle.html";
          //   }, 1000);
          // }
        });
        plotarGrafico(resposta, idSensor);
      });
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });
  }

  var count = 0;

  function plotarGrafico(resposta, idSensor) {

    console.log('iniciando plotagem do grafico...')

    let labels = [];
    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'TEMPERATURA',
        data: [],
        fill: false,
        backgroundColor: '#fd582f',
        borderColor: '#fd582f',
        tension: 0.1,
      }],
    };
    let labelsUmid = [];
    let dadosUmid = {
      labels: labelsUmid,
      datasets: [{
        label: 'UMIDADE',
        data: [],
        fill: false,
        backgroundColor: '#6633ff',
        borderColor: '#6633ff',
        tension: 0.1,
      }],
    }

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      // labels.push(registro);
      if (registro.uniMedida == `°C`) {
        labels.push(`${registro.stats}`); // POR QUE AQUI É IDHIST AO INVES DE FKSENSOR, OQ SIGNIFICA ESSE +10H 
        dados.datasets[0].data.push(registro.stats);
      }
      if (registro.uniMedida == `%`) {
        labelsUmid.push(`${registro.stats}`);
        dadosUmid.datasets[0].data.push(registro.stats);
      }
      //   dadosUmid.datasets[0].data.push(null);
      // } else if (registro.uniMedida == '%') {
      //   dadosUmid.datasets[0].data.push(registro.stats);
    }

    // dadosTemp.datasets[0].data.push(registro.stats);
    // dados.datasets[1].data.push(registro.dataBaseDamage);
    // dados.datasets[2].data.push(registro.dataBaseDefense);
    // dados.datasets[3].data.push(registro.dataBaseEvasion);


    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels: TEMP')
    console.log(labels)
    console.log('Dados: DA TEMPERATURA')
    console.log(dados.datasets)
    console.log('Dados: DA UMIDADE')
    // console.log(dadosUmid.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: dados,
    };

    const configUmid = {
      type: 'line',
      data: dadosUmid,
    };

    // if (myCh) {
    // ctx.id = `myChartTemp${idSensor}`; // DEIXAR O GRÁFICO DINÂMICO
    // }


    // var ctx = canvas.getContext('2d');

    // if (`window.myChartTemp${idSensor}`) {
    //   `window.myChartTemp${idSensor}`.destroy();
    // }

    // Adicionando gráfico criado em div na tel
    // if (myChartTemp){
    //   myChartTemp.destroy();
    // }
    // if (contador == 0) {


    let myChartTemp = new Chart(
      document.getElementById(`myChartTemp${idSensor}`),
      config
    );

    let myChartUmid = new Chart(
      document.getElementById(`myChartUmid${idSensor}`),
      configUmid
    );


    setTimeout(() => atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid), 2000);

    // }
    // destruirGrafico();
    // contador = 1;

    // let myChartUmid = new Chart(
    //   document.getElementById(`graficoUmid`),
    //   configUmid
    // );



    function atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid) {
      if (myChartTemp) {
        myChartTemp.destroy();
      }
      if (myChartUmid) {
        myChartUmid.destroy();
      }

      if (resposta[0].uniMedida == "°C") {
        temp.innerHTML += `<span>${resposta[resposta.length - 1].stats}${resposta[resposta.length - 1].uniMedida}</span>`
      }

      fetch(`/sensores/dadosTempoReal/${idSensor}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            dadosSensor(idSensor); // AQUI ERA PRA FICAR O ID
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
              console.log("---------------------------------------------------------------")
              console.log("Como não há dados novos para captura, o gráfico não atualizará.")
              console.log("Horário do novo dado capturado:")
              console.log(novoRegistro[0].momento_grafico)
              console.log("Horário do último dado capturado:")
              console.log(dados.labels[dados.length - 1])
              console.log("---------------------------------------------------------------")
            } else {
              // tirando e colocando valores no gráfico
              dados.labels.shift(); // apagar o primeiro
              dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento


              dados.datasets[0].data.shift();  // apagar o primeiro de umidade
              dados.datasets[0].data.push(novoRegistro[0].stats); // incluir uma nova medida de umidade

              // dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
              // dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura 
              // NECESSITA CONFIGURAR, OLHAR NO FONTS/SOURCES




              myChartTemp.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid), 2000);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid), 2000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }





    // const ChartTemp = document.getElementById('graficoTemp');

    // new Chart(ChartTemp, {
    //   type: 'line',
    //   data: {
    //     labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
    //     datasets: [{
    //       label: 'Temperatura °C',
    //       data: [12, 19, 3, 5, 2, 3],
    //       backgroundColor: '#fd582f',
    //       borderColor: '#fd582f'
    //     }]
    //   },
    //   options: {
    //     scales: {
    //       y: {
    //         beginAtZero: true
    //       }
    //     }
    //   }
    // });

    // const ChartUmi = document.getElementById('graficoUmi');

    // new Chart(ChartUmi, {
    //   type: 'line',
    //   data: {
    //     labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
    //     datasets: [{
    //       label: 'Umidade %',
    //       data: [12, 19, 3, 5, 2, 3],
    //       backgroundColor: '#6633ff',
    //       borderColor: '#6633ff',
    //     }]
    //   },
    //   options: {
    //     scales: {
    //       y: {
    //         beginAtZero: true
    //       }
    //     }
    //   }
    // });

  }

  function gerarPDF() {

    var doc = new jsPDF();

    var chartTemp = document.getElementById(`myChartTemp${idSensor}`);
    var imageDataTemp = chartTemp.toDataURL('image/png');

    doc.addImage(imageDataTemp, 'PNG', 10, 10, 90, 45);

    let espaçoEntre = 50;

    var chartUmi = document.getElementById(`myChartUmid${idSensor}`);
    var imageDataUmi = chartUmi.toDataURL('image/png');

    doc.addImage(imageDataUmi, 'PNG', 10, 10 + espaçoEntre, 90, 45);

    doc.save('relatório.pdf');
  }
</script>